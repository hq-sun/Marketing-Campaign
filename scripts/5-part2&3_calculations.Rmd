---
title: "Part 2&3 Calculations"
author: "Heqing Sun"
date: "6/18/2020"
output: html_document
---

## Environment Setup
```{r}
# setwd('/Users/sun/Documents/GitHub/Terminix-Data-Challenge')
getwd()

# If this errors out, need to install packages
source('0-setup_environment.R')
```

## Access the RDS file from previous steps
```{r}
train_data <- readRDS('../data/clean/train_data.rds')
test_data <- readRDS('../data/clean/test_data.rds')
data_sub_mi <- readRDS('../data/clean/data_sub_mi.rds')
```

## Data Preparation
```{r}
# Use the same partition method to split the data_sub_mi to get test data index
set.seed(123)
m.smp_size <- floor(0.75 * nrow(data_sub_mi))
m.train_ind <- sample(seq_len(nrow(data_sub_mi)), size = m.smp_size)
m.test <- data_sub_mi[-m.train_ind, ]

# Set Ref1 as the index
rownames(test_data) <- rownames(m.test)
```

## Use ROSE Logistic Regression
```{r}
# Convert target variable to factor
train_data$sale <- as.factor(train_data$sale)
test_data$sale <- as.factor(test_data$sale)

set.seed(123)
ctrl <- trainControl(method = "repeatedcv", 
                     number = 10, 
                     repeats = 10, 
                     verboseIter = FALSE,
                     sampling = "rose")

model_lr_rose <- caret::train(sale ~ .,
                              data = train_data,
                              method = "glm",
                              preProcess = c("scale", "center"),
                              trControl = ctrl)

final_rose <- data.frame(actual = test_data$sale,
                          predict(model_lr_rose, newdata = test_data, type = "prob"))
final_rose$predict <- ifelse(final_rose$X0 > 0.5, 0, 1)

cm_rose <- confusionMatrix(factor(final_rose$predict), factor(final_rose$actual), positive = "1")
cm_rose
```

## Plot Precision - Recall Curve
```{r}
# Get each class's probabilities
m.a <- final_rose %>% filter(actual==1)
m.pc <-  m.a$X1
m.b <- final_rose %>% filter(actual==0)
m.nc <-  m.b$X1

# PR Curve
pr <- pr.curve(scores.class0 = m.pc, scores.class1 = m.nc, curve = T)
plot(pr, auc.main=FALSE)

# Create a dateframe that contains thw detailed values
m.threshold <- data.frame(pr$curve)
colnames(m.threshold) <- c("recall", "precision", "threshold")
## Find that when the threshold >= 0.5832411, the precision will greater than 1/3
```

# Part 2 - Select Promising Records
```{r}
selected <- final_rose %>% filter(X1 >= 0.5832411) ## 447 obs
table(selected$actual)
#   0   1 
# 298 149 

selected
write.csv(selected,'../data/clean/selected_records_for_campaign.csv')

# Clean up environment
rm(list = ls(pattern = "^m."))
```

## Part 3 - Calculate the Sample Size
```{r}
# Calculate the sales rate in the test data
summary(test_data$sale)
## ~ 0.18

power.prop.test(p1=0.18, p2=0.18*1.05, power=0.8, alternative='two.sided', sig.level=0.1)
```

```{r}
# Calculate the sales rate in the test data
summary(test_data$sale)
## ~ 0.18
power.prop.test(p1=0.18, p2=0.18*1.05, power=0.8, alternative='two.sided', sig.level=0.05)
power.prop.test(p1=0.18, p2=0.18*1.05, power=0.8, alternative='one.sided', sig.level=0.1)
```